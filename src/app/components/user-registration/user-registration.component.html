<ion-header mode="ios" class="ion-padding-vertical">
  <ion-toolbar mode="ios" class="header-user-registration">
    <ion-buttons slot="start" *ngIf="marcaSeleccionada">
      <ion-button (click)="backToMarcas()" *ngIf="!modeloSeleccionado" mode="ios">
        <img src="assets/iconsax-svg/All/linear/arrow-left.svg" alt="back">
      </ion-button>
      <ion-button (click)="backToModelos()" *ngIf="modeloSeleccionado && currentStep === 'vehicle-selection'" mode="ios">
        <img src="assets/iconsax-svg/All/linear/arrow-left.svg" alt="back">
      </ion-button>
      <ion-button (click)="backToPlaca()" *ngIf="currentStep === 'personal-info'" mode="ios">
        <img src="assets/iconsax-svg/All/linear/arrow-left.svg" alt="back">
      </ion-button>
    </ion-buttons>
    <ion-title slot="start">{{ getTitleForCurrentStep() }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismissModal()">
        <img src="assets/iconsax-svg/All/bulk/close-circle.svg" alt="Cerrar">
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <ion-item class="my-vehicle-card" [@fadeInOut]>
    <img slot="start" [src]="selectedVehicle.icon || '../../assets/icon-vehicle-type/Automovil.svg'" [alt]="selectedVehicle.name || 'vehículo'">
    <ion-label>
      <ion-text *ngIf="!marcaSeleccionada">
        <h3>{{ selectedVehicle.description || 'Carro y camioneta' }}</h3>
      </ion-text>
      <ion-text *ngIf="marcaSeleccionada">
        <h3>{{ marcaSeleccionada }}</h3>
        <p>{{ modeloSeleccionado }}</p>
      </ion-text>
    </ion-label>
    <div slot="end" class="placa" *ngIf="placa">
      <h5>{{ placa }}</h5>
    </div>
  </ion-item>

  <!-- Sección de selección de vehículo -->
  <div *ngIf="currentStep === 'vehicle-selection'"  [@fadeInOut]>
    <!-- Sección de Marcas -->
    <div *ngIf="!marcaSeleccionada" [@fadeInOut]>
      <ion-searchbar 
        [(ngModel)]="searchTerm" 
        (ionChange)="filterMarcas()" 
        placeholder="Buscar marca"
        mode="ios">
      </ion-searchbar>

      <ion-list mode="ios">
        <ion-item *ngFor="let marca of filteredMarcas" (click)="selectMarca(marca)" mode="ios">
          <ion-label>{{ marca }}</ion-label>
        </ion-item>
      </ion-list>
    </div>

    <!-- Sección de Modelos -->
    <div *ngIf="marcaSeleccionada && !modeloSeleccionado"  [@fadeInOut]>

      <ion-searchbar 
        [(ngModel)]="searchTerm" 
        (ionChange)="filterModelos()" 
        placeholder="Buscar modelo" mode="ios">
      </ion-searchbar>

      <ion-list mode="ios">
        <ion-item *ngFor="let modelo of filteredModelos" (click)="selectModelo(modelo)" mode="ios">
          <ion-label>{{ modelo }}</ion-label>
        </ion-item>
      </ion-list>
    </div>

    <!-- Sección de Placa -->
    <div *ngIf="marcaSeleccionada && modeloSeleccionado"  [@fadeInOut]>

      <div class="title-form">
        <h2>¿Cómo es la placa?</h2>
        <p>Escribe la placa del vehículo para que el conductor te logre identificar</p>
      </div>

      <form (ngSubmit)="registerUser()" class="login-form">
        <ion-item lines="none" mode="ios" class="input-desvare">
          <img slot="start" src="assets/iconsax-svg/All/bulk/barcode.svg" alt="lock">
          <ion-input [(ngModel)]="placa" label="Placa del vehículo" name="placa" required label-placement="floating" placeholder="ABC-123"></ion-input>
        </ion-item>

        <ion-button expand="block" type="submit" [disabled]="!placa" mode="ios">
          Continuar
        </ion-button>
      </form>
    </div>
  </div>

  <!-- Sección de información personal -->
  <div *ngIf="currentStep === 'personal-info'"  [@fadeInOut]>

    <div class="title-form">
      <h2>Y por ultimo!</h2>
      <p>Agrega los siguientes datos para que el conductor pueda contactarte</p>
    </div>

    <form [formGroup]="personalInfoForm" (ngSubmit)="onSubmit()" class="login-form">
      
      <ion-item lines="none" mode="ios" class="input-desvare">
        <img slot="start" src="assets/iconsax-svg/All/bulk/profile-circle.svg" alt="lock">
        <ion-input formControlName="username" type="text" label="Nombre de usuario" required label-placement="floating" placeholder="Como te llamas?"></ion-input>
      </ion-item>
      <ion-text color="danger" *ngIf="personalInfoForm.get('username')?.hasError('required') && personalInfoForm.get('username')?.touched">
        El nombre de usuario es requerido.
      </ion-text>

      <ion-item lines="none" mode="ios" class="input-desvare">
        <img slot="start" src="assets/iconsax-svg/All/bulk/message.svg" alt="lock">
        <ion-input formControlName="email" type="email" label="Email" required label-placement="floating" placeholder="tuemail@ejemplo.com"></ion-input>
      </ion-item>
      <ion-text color="danger" *ngIf="personalInfoForm.get('email')?.hasError('required') && personalInfoForm.get('email')?.touched">
        El email es requerido.
      </ion-text>
      <ion-text color="danger" *ngIf="personalInfoForm.get('email')?.hasError('email') && personalInfoForm.get('email')?.touched">
        Por favor, ingrese un email válido.
      </ion-text>

      <ion-item lines="none" mode="ios" class="input-desvare">
        <img slot="start" src="assets/iconsax-svg/All/bulk/call.svg" alt="lock">
        <ion-input formControlName="phone" type="tel" label="Número celular" required label-placement="floating" placeholder="000 000 0000"></ion-input>
      </ion-item>
      <ion-text color="danger" *ngIf="personalInfoForm.get('phone')?.hasError('required') && personalInfoForm.get('phone')?.touched">
        El número celular es requerido.
      </ion-text>
      <ion-text color="danger" *ngIf="personalInfoForm.get('phone')?.hasError('pattern') && personalInfoForm.get('phone')?.touched">
        Por favor, ingrese un número celular válido.
      </ion-text>

      <ion-button expand="block" type="submit" mode="ios" [disabled]="personalInfoForm.invalid">
        Finalizar registro
      </ion-button>
    </form>
  </div>

  <ion-spinner *ngIf="loading"  [@fadeInOut]></ion-spinner>
  <ion-text color="danger" *ngIf="error" [@fadeInOut]>{{ error }}</ion-text>
</ion-content>